[{"name": "app.py", "content": "#\n# Heatmapper\n# Geomap\n#\n# This file contains the ShinyLive application for Geomap Heatmapper.\n# It can be run with the following command within this directory:\n#\t\tshinylive export . [site]\n# Where [site] is the destination of the site folder.\n#\n# If you would rather deploy the application as a PyShiny application,\n# run the following command within this directory:\n#\t\tshiny run\n#\n# Last Modified: 2024/02/06\n#\n\nfrom shiny import App, Inputs, Outputs, Session, reactive, render, ui\nfrom shiny.types import FileInfo\nfrom folium import Map as FoliumMap, Choropleth\nfrom folium.plugins import HeatMap\nfrom pandas import DataFrame, read_csv, read_excel, read_table\nfrom pathlib import Path\nfrom io import BytesIO\nfrom sys import modules\n\n\n# Interoperability between ShinyLive and PyShiny\nif \"pyodide\" in modules:\n\tfrom pyodide.http import pyfetch\n\tSource = \"https://raw.githubusercontent.com/kkernick/kkernick.github.io/main/geomap/example_input/\"\n\tasync def download(url): r = await pyfetch(url); return await r.bytes() if r.ok else None\nelse:\n\tfrom os.path import exists\n\tSource = \"../example_input/\"\n\tasync def download(url): return open(url, \"rb\").read() if exists(url) else None\n\n\n# Generated from dictionary.sh\njson_mappings = { \"africa.geojson\": \"Africa\", \"akron.geojson\": \"Akron\", \"alameda.geojson\": \"Alameda\", \"albany.geojson\": \"Albany\", \"albuquerque.geojson\": \"Albuquerque\", \"amsterdam.geojson\": \"Amsterdam\", \"amusement-parks.geojson\": \"Amusement Parks\", \"anchorage.geojson\": \"Anchorage\", \"angers.geojson\": \"Angers\", \"angers-loire-metropole.geojson\": \"Angers Loire Metropole\", \"antwerp.geojson\": \"Antwerp\", \"apulia.geojson\": \"Apulia\", \"arlingtonva.geojson\": \"Arlingtonva\", \"asia.geojson\": \"Asia\", \"athens.geojson\": \"Athens\", \"atlanta.geojson\": \"Atlanta\", \"augsburg.geojson\": \"Augsburg\", \"austin.geojson\": \"Austin\", \"australia.geojson\": \"Australia\", \"austria-oberoesterreich.geojson\": \"Austria Oberoesterreich\", \"austria-states.geojson\": \"Austria States\", \"austria-steiermark.geojson\": \"Austria Steiermark\", \"bad-belzig.geojson\": \"Bad Belzig\", \"badenwuerttemberg-kreise.geojson\": \"Badenwuerttemberg Kreise\", \"baltimore.geojson\": \"Baltimore\", \"bari.geojson\": \"Bari\", \"basel.geojson\": \"Basel\", \"bayern.geojson\": \"Bayern\", \"belgium-arrondissements.geojson\": \"Belgium Arrondissements\", \"berlin.geojson\": \"Berlin\", \"bern-districts.geojson\": \"Bern Districts\", \"bern-quarters.geojson\": \"Bern Quarters\", \"birmingham.geojson\": \"Birmingham\", \"blacksburg.geojson\": \"Blacksburg\", \"blumenau.geojson\": \"Blumenau\", \"bogota.geojson\": \"Bogota\", \"boston.geojson\": \"Boston\", \"brandenburg.geojson\": \"Brandenburg\", \"brandenburg-municipalities.geojson\": \"Brandenburg Municipalities\", \"braunschweig.geojson\": \"Braunschweig\", \"brazil-states.geojson\": \"Brazil States\", \"bremen.geojson\": \"Bremen\", \"bronx.geojson\": \"Bronx\", \"brooklyn.geojson\": \"Brooklyn\", \"buenos-aires.geojson\": \"Buenos Aires\", \"calgary.geojson\": \"Calgary\", \"california-counties.geojson\": \"California Counties\", \"california-vista-points.geojson\": \"California Vista Points\", \"caltrain-stations.geojson\": \"Caltrain Stations\", \"canada.geojson\": \"Canada\", \"canberra.geojson\": \"Canberra\", \"caribbean-islands.geojson\": \"Caribbean Islands\", \"chapel-hill.geojson\": \"Chapel Hill\", \"charlotte.geojson\": \"Charlotte\", \"charlottesville.geojson\": \"Charlottesville\", \"chemnitz.geojson\": \"Chemnitz\", \"chesapeake.geojson\": \"Chesapeake\", \"chicago.geojson\": \"Chicago\", \"china.geojson\": \"China\", \"cincinnati.geojson\": \"Cincinnati\", \"cleveland.geojson\": \"Cleveland\", \"cologne.geojson\": \"Cologne\", \"colorado-counties.geojson\": \"Colorado Counties\", \"columbus.geojson\": \"Columbus\", \"copenhagen.geojson\": \"Copenhagen\", \"cuba.geojson\": \"Cuba\", \"dallas.geojson\": \"Dallas\", \"dane-county-municipalities.geojson\": \"Dane County Municipalities\", \"denmark-municipalities.geojson\": \"Denmark Municipalities\", \"denver.geojson\": \"Denver\", \"des-moines.geojson\": \"Des Moines\", \"detroit.geojson\": \"Detroit\", \"dictionary.sh\": \"Dictionary\", \"dresden.geojson\": \"Dresden\", \"dublin.geojson\": \"Dublin\", \"duesseldorf.geojson\": \"Duesseldorf\", \"durham.geojson\": \"Durham\", \"edmonton.geojson\": \"Edmonton\", \"eindhoven.geojson\": \"Eindhoven\", \"enschede.geojson\": \"Enschede\", \"esztergom.geojson\": \"Esztergom\", \"europe-1914.geojson\": \"Europe 1914\", \"europe-1938.geojson\": \"Europe 1938\", \"europe-capitals.geojson\": \"Europe Capitals\", \"europe.geojson\": \"Europe\", \"fairbanks.geojson\": \"Fairbanks\", \"fargo.geojson\": \"Fargo\", \"fort-lauderdale.geojson\": \"Fort Lauderdale\", \"france-departments.geojson\": \"France Departments\", \"france-regions.geojson\": \"France Regions\", \"frankfurt-main.geojson\": \"Frankfurt Main\", \"freiburg.geojson\": \"Freiburg\", \"geneva.geojson\": \"Geneva\", \"germany-capitals.geojson\": \"Germany Capitals\", \"germany.geojson\": \"Germany\", \"ghent.geojson\": \"Ghent\", \"gisborne.geojson\": \"Gisborne\", \"grand-rapids.geojson\": \"Grand Rapids\", \"greece-prefectures.geojson\": \"Greece Prefectures\", \"greece-regions.geojson\": \"Greece Regions\", \"hamburg.geojson\": \"Hamburg\", \"hampton.geojson\": \"Hampton\", \"hartford.geojson\": \"Hartford\", \"henderson.geojson\": \"Henderson\", \"honolulu.geojson\": \"Honolulu\", \"houston.geojson\": \"Houston\", \"hungary.geojson\": \"Hungary\", \"illinois-counties.geojson\": \"Illinois Counties\", \"india.geojson\": \"India\", \"indianapolis.geojson\": \"Indianapolis\", \"iran-provinces.geojson\": \"Iran Provinces\", \"ireland-counties.geojson\": \"Ireland Counties\", \"isle-of-man.geojson\": \"Isle Of Man\", \"italy-provinces.geojson\": \"Italy Provinces\", \"italy-regions.geojson\": \"Italy Regions\", \"james-city-county.geojson\": \"James City County\", \"japan.geojson\": \"Japan\", \"kaiserslautern.geojson\": \"Kaiserslautern\", \"kansas-city.geojson\": \"Kansas City\", \"korea.geojson\": \"Korea\", \"las-vegas.geojson\": \"Las Vegas\", \"leipzig.geojson\": \"Leipzig\", \"le-mans-cantons.geojson\": \"Le Mans Cantons\", \"lexington.geojson\": \"Lexington\", \"liberia-central.geojson\": \"Liberia Central\", \"liberia-east.geojson\": \"Liberia East\", \"liberia.geojson\": \"Liberia\", \"liberia-west.geojson\": \"Liberia West\", \"lombardy.geojson\": \"Lombardy\", \"london.geojson\": \"London\", \"london-underground.geojson\": \"London Underground\", \"long-beach.geojson\": \"Long Beach\", \"los-angeles-county.geojson\": \"Los Angeles County\", \"los-angeles.geojson\": \"Los Angeles\", \"louisville.geojson\": \"Louisville\", \"luxembourg-cantons.geojson\": \"Luxembourg Cantons\", \"luxembourg-communes.geojson\": \"Luxembourg Communes\", \"luzern.geojson\": \"Luzern\", \"macon.geojson\": \"Macon\", \"madrid-districts.geojson\": \"Madrid Districts\", \"madrid.geojson\": \"Madrid\", \"malaysia.geojson\": \"Malaysia\", \"manhattan-bridges.geojson\": \"Manhattan Bridges\", \"manhattan.geojson\": \"Manhattan\", \"melbourne.geojson\": \"Melbourne\", \"mexico.geojson\": \"Mexico\", \"miami.geojson\": \"Miami\", \"middle_east_countries.geojson\": \"Middle_east_countries\", \"milan.geojson\": \"Milan\", \"milwaukee.geojson\": \"Milwaukee\", \"minneapolis-cities.geojson\": \"Minneapolis Cities\", \"minneapolis.geojson\": \"Minneapolis\", \"mississauga.geojson\": \"Mississauga\", \"montreal.geojson\": \"Montreal\", \"moscow.geojson\": \"Moscow\", \"muenster.geojson\": \"Muenster\", \"new-haven.geojson\": \"New Haven\", \"new-orleans.geojson\": \"New Orleans\", \"new-york-areas-of-interest.geojson\": \"New York Areas Of Interest\", \"new-york-city-boroughs.geojson\": \"New York City Boroughs\", \"new-york-counties.geojson\": \"New York Counties\", \"nordrhein-westfalen.geojson\": \"Nordrhein Westfalen\", \"norfolk.geojson\": \"Norfolk\", \"north-america.geojson\": \"North America\", \"north-carolina-cities.geojson\": \"North Carolina Cities\", \"oakland.geojson\": \"Oakland\", \"oceania.geojson\": \"Oceania\", \"oklahoma-cities.geojson\": \"Oklahoma Cities\", \"oklahoma-counties.geojson\": \"Oklahoma Counties\", \"olympia.geojson\": \"Olympia\", \"oman.geojson\": \"Oman\", \"oman-provinces.geojson\": \"Oman Provinces\", \"orlando.geojson\": \"Orlando\", \"pakistan.geojson\": \"Pakistan\", \"paris.geojson\": \"Paris\", \"peaks.geojson\": \"Peaks\", \"philadelphia.geojson\": \"Philadelphia\", \"phoenix.geojson\": \"Phoenix\", \"pittsburgh.geojson\": \"Pittsburgh\", \"poland.geojson\": \"Poland\", \"poland-parks.geojson\": \"Poland Parks\", \"porirua.geojson\": \"Porirua\", \"portland.geojson\": \"Portland\", \"portugal.geojson\": \"Portugal\", \"potsdam.geojson\": \"Potsdam\", \"prague.geojson\": \"Prague\", \"providence.geojson\": \"Providence\", \"quebec.geojson\": \"Quebec\", \"queens.geojson\": \"Queens\", \"raleigh.geojson\": \"Raleigh\", \"red-deer.geojson\": \"Red Deer\", \"richmond.geojson\": \"Richmond\", \"riga.geojson\": \"Riga\", \"rio-de-janeiro.geojson\": \"Rio De Janeiro\", \"rochester.geojson\": \"Rochester\", \"rockville.geojson\": \"Rockville\", \"roller-coasters-fastest-steel.geojson\": \"Roller Coasters Fastest Steel\", \"romania.geojson\": \"Romania\", \"rome-rioni.geojson\": \"Rome Rioni\", \"rotterdam.geojson\": \"Rotterdam\", \"russia.geojson\": \"Russia\", \"sacramento.geojson\": \"Sacramento\", \"salt-lake-city.geojson\": \"Salt Lake City\", \"san-antonio.geojson\": \"San Antonio\", \"san-diego.geojson\": \"San Diego\", \"san-francisco.geojson\": \"San Francisco\", \"san-jose.geojson\": \"San Jose\", \"saskatoon.geojson\": \"Saskatoon\", \"savannah.geojson\": \"Savannah\", \"seattle.geojson\": \"Seattle\", \"seoul.geojson\": \"Seoul\", \"serbia.geojson\": \"Serbia\", \"silicon-valley.geojson\": \"Silicon Valley\", \"south-africa.geojson\": \"South Africa\", \"south-america.geojson\": \"South America\", \"southeast-asia.geojson\": \"Southeast Asia\", \"spain-communities.geojson\": \"Spain Communities\", \"spain-provinces.geojson\": \"Spain Provinces\", \"springfield.geojson\": \"Springfield\", \"stamford.geojson\": \"Stamford\", \"staten-island.geojson\": \"Staten Island\", \"st-louis.geojson\": \"St Louis\", \"st-petersburg.geojson\": \"St Petersburg\", \"surrey.geojson\": \"Surrey\", \"sweden-counties.geojson\": \"Sweden Counties\", \"switzerland.geojson\": \"Switzerland\", \"sydney.geojson\": \"Sydney\", \"szczecin.geojson\": \"Szczecin\", \"taiwan.geojson\": \"Taiwan\", \"tampa.geojson\": \"Tampa\", \"the-hague.geojson\": \"The Hague\", \"the-netherlands.geojson\": \"The Netherlands\", \"thessaloniki.geojson\": \"Thessaloniki\", \"toronto.geojson\": \"Toronto\", \"tucson.geojson\": \"Tucson\", \"turkey.geojson\": \"Turkey\", \"turku.geojson\": \"Turku\", \"ulm.geojson\": \"Ulm\", \"united-kingdom.geojson\": \"United Kingdom\", \"united-kingdom-regions.geojson\": \"United Kingdom Regions\", \"united-states-1810.geojson\": \"United States 1810\", \"united-states-big-cities.geojson\": \"United States Big Cities\", \"united-states.geojson\": \"United States\", \"united-states-international-airports.geojson\": \"United States International Airports\", \"united-states-mlb-stadiums.geojson\": \"United States Mlb Stadiums\", \"unna.geojson\": \"Unna\", \"utrecht.geojson\": \"Utrecht\", \"vancouver.geojson\": \"Vancouver\", \"venice.geojson\": \"Venice\", \"venlo.geojson\": \"Venlo\", \"vermont-counties.geojson\": \"Vermont Counties\", \"vienna.geojson\": \"Vienna\", \"villetta.geojson\": \"Villetta\", \"washington.geojson\": \"Washington\", \"wellington.geojson\": \"Wellington\", \"west-linn.geojson\": \"West Linn\", \"west-palm-beach.geojson\": \"West Palm Beach\", \"wiesenburg.geojson\": \"Wiesenburg\", \"williamsburg.geojson\": \"Williamsburg\", \"windsor.geojson\": \"Windsor\", \"winterthur.geojson\": \"Winterthur\", \"zurich-city.geojson\": \"Zurich City\", \"zurich.geojson\": \"Zurich\" }\n\n\ndef server(input: Inputs, output: Outputs, session: Session):\n\n\tCache = {}\n\n\tasync def LoadData():\n\t\t\"\"\"\n\t\t@brief Returns the DataFrame representation of the data to place on the map\n\t\t@returns The DataFrame\n\t\t\"\"\"\n\n\t\t# Grab an uploaded file, if its done, or grab an example (Using a cache to prevent redownload)\n\t\tif input.SourceFile() == \"Upload\":\n\t\t\tfile: list[FileInfo] | None = input.File()\n\t\t\tif file is None:\n\t\t\t\t\treturn DataFrame()\n\t\t\tn = file[0][\"name\"]\n\t\t\tf = file[0][\"datapath\"]\n\t\telse:\n\t\t\tn = input.Example()\n\t\t\tf = Cache[n] if n in Cache else BytesIO(await download(Source + input.Example()))\n\n\t\tmatch Path(n).suffix:\n\t\t\tcase \".csv\": return read_csv(f)\n\t\t\tcase \".xlsx\": return read_excel(f)\n\t\t\tcase _: return read_table(f)\n\n\n\tasync def LoadMap():\n\t\t\"\"\"\n\t\t@brief Generates a map with the provided information\n\t\t@returns the Folium.Map\n\t\t\"\"\"\n\t\tdf = await LoadData()\n\n\t\t# Give a placeholder map if nothing is selected, which should never really be the case.\n\t\tif df.empty:\n\t\t\treturn FoliumMap((53.5213, -113.5213), tiles=input.MapType(), zoom_start=15)\n\n\t\t# Create map\n\t\tmap = FoliumMap(tiles=input.MapType())\n\n\t\tkey = df.columns[0] if input.KeyColumn() is None else input.KeyColumn()\n\t\tvalue = df.columns[1] if input.ValueColumn() is None else input.ValueColumn()\n\n\t\t# Add the heatmap and return.\n\t\tChoropleth(\n\t\t\t\tgeo_data=\"https://raw.githubusercontent.com/kkernick/kkernick.github.io/main/geomap/data/\" + input.JSON(),\n\t\t\t\tname='choropleth',\n\t\t\t\tdata=df,\n\t\t\t\tcolumns=[key, value],\n\t\t\t\tkey_on='feature.properties.name',\n\t\t\t\tfill_color='YlGn',\n\t\t\t\tfill_opacity=input.Opacity(),\n\t\t\t\tline_opacity=input.Opacity(),\n\t\t\t\tlegend_name='Legend',\n\t\t\t\tbins=input.Bins()\n\t\t).add_to(map)\n\t\treturn map\n\n\n\t@output\n\t@render.table\n\tasync def LoadedTable(): return await LoadData()\n\n\n\t@output\n\t@render.ui\n\tasync def Map(): return await LoadMap()\n\n\n\t@output\n\t@render.text\n\tdef ExampleInfo(): return Info[input.Example()]\n\n\n\t@session.download(filename=\"table.csv\")\n\tasync def DownloadTable(): yield await LoadData().to_string()\n\n\n\t@session.download(filename=\"heatmap.html\")\n\tasync def DownloadHeatmap(): yield await LoadMap().get_root().render()\n\n\n\t@reactive.Effect\n\tasync def _():\n\n\t\t# Give options for the key and value columns\n\t\tdf = await LoadData()\n\t\tchoices = df.columns.tolist()\n\t\tif choices:\n\t\t\tdefault_key = input.KeyColumn() if input.KeyColumn() is not None else df.columns[0]\n\t\t\tdefault_value = input.ValueColumn() if input.ValueColumn() is not None else df.columns[1]\n\n\t\t\tui.update_select(id=\"KeyColumn\", choices=choices, selected=default_key)\n\t\t\tui.update_select(id=\"ValueColumn\", choices=choices, selected=default_value)\n\n\napp_ui = ui.page_fluid(\n\n\tui.panel_title(title=None, window_title=\"Heatmapper\"),\n\t\tui.navset_bar(\n\t\t\tui.nav_panel(ui.HTML(\"<a href=https://kkernick.github.io/expression/site/index.html>Expression</a>\"), value=\"Expression\"),\n\t\t\tui.nav_panel(ui.HTML(\"<a href=https://kkernick.github.io/pairwise/site/index.html>Pairwise</a>\"), value=\"Pairwise\"),\n\t\t\tui.nav_panel(ui.HTML(\"<a href=https://kkernick.github.io/image/site/index.html>Image</a>\"), value=\"Image\"),\n\t\t\tui.nav_panel(ui.HTML(\"<a href=https://kkernick.github.io/geomap/site/index.html>Geomap</a>\"), value=\"Geomap\"),\n\t\t\tui.nav_panel(ui.HTML(\"<a href=https://kkernick.github.io/geocoordinate/site/index.html>Geocoordinate</a>\"), value=\"Geocoordinate\"),\n\t\t\tui.nav_panel(ui.HTML(\"<a href=https://kkernick.github.io/about/site/index.html>About</a>\"), value=\"About\"),\n\t\t\ttitle=\"Heatmapper\",\n\t\t\tselected=\"Geomap\",\n\t),\n\n\tui.layout_sidebar(\n\t\tui.sidebar(\n\n\t\t\t# If the user needs help with the formatting.\n\t\t\tui.HTML(\"<a href=https://kkernick.github.io/about/site/index.html>Data Format</a>\"),\n\n\t\t\t# Specify whether to use example files, or upload one.\n\t\t\tui.input_radio_buttons(id=\"SourceFile\", label=\"Specify a Source File\", choices=[\"Example\", \"Upload\"], selected=\"Example\"),\n\n\t\t\t# Only display an input dialog if the user is one Upload\n\t\t\tui.panel_conditional(\n\t\t\t\t\"input.SourceFile === 'Upload'\",\n\t\t\t\tui.input_file(\"File\", \"Choose a File\", accept=[\".csv\", \".txt\", \"xlsx\"], multiple=False),\n\t\t\t),\n\n\t\t\t# Otherwise, add the example selection and an info button.\n\t\t\tui.panel_conditional(\n\t\t\t\t\"input.SourceFile === 'Example'\",\n\n\t\t\t\t# Put them side-by-side.\n\t\t\t\tui.layout_columns(\n\n\t\t\t\t\tui.input_select(id=\"Example\", label=None, choices={\n\t\t\t\t\t\t\"example1.txt\": \"Example 1\",\n\t\t\t\t\t\t\"example2.txt\": \"Example 2\",\n\t\t\t\t\t\t\"example3.txt\": \"Example 3\",\n\t\t\t\t\t\t\"example5.txt\": \"Example 5\"},\n\t\t\t\t\t\tmultiple=False),\n\t\t\t\t\tui.popover(ui.input_action_link(id=\"ExampleInfoButton\", label=\"Info\"), ui.output_text(\"ExampleInfo\")),\n\t\t\t\t\tcol_widths=[10,2],\n\t\t\t\t)\n\t\t\t),\n\n\t\t\tui.input_select(id=\"JSON\", label=None, choices=json_mappings, multiple=False),\n\n\t\t\tui.input_select(id=\"KeyColumn\", label=\"Key\", choices=[], multiple=False),\n\t\t\tui.input_select(id=\"ValueColumn\", label=\"Value\", choices=[], multiple=False),\n\n\n\t\t\t# All the features related to map customization are here.\n\t\t\tui.HTML(\"Map Customization\"),\n\n\t\t\t# Only OpenStreatMap and CartoDB Positron seem to work.\n\t\t\tui.input_radio_buttons(id=\"MapType\", label=\"Map Type\", choices=[\"OpenStreetMap\", \"CartoDB Positron\"], selected=\"CartoDB Positron\"),\n\n\t\t\tui.input_slider(id=\"Opacity\", label=\"Heatmap Opacity\", value=0.5, min=0.0, max=1.0, step=0.1),\n\t\t\tui.input_slider(id=\"Bins\", label=\"Number of Colors\", value=8, min=3, max=12, step=1),\n\n\t\t\t# Add the download buttons.\n\t\t\tui.layout_columns(\n\t\t\t\tui.download_button(\"DownloadHeatmap\", \"Download Heatmap\"),\n\t\t\t\tui.download_button(\"DownloadTable\", \"Download Table\")\n\t\t\t),\n\n\t\t\tid=\"SidebarPanel\",\n\t\t\twidth=350\n\t\t),\n\n\t\t# Add the main interface tabs.\n\t\tui.navset_tab(\n\t\t\t\tui.nav_panel(\"Interactive\", ui.output_ui(\"Map\")),\n\t\t\t\tui.nav_panel(\"Table\", ui.output_table(\"LoadedTable\"),),\n\t\t),\n\t)\n)\n\napp = App(app_ui, server)", "type": "text"}, {"name": "requirements.txt", "content": "folium", "type": "text"}]