[{"name": "app.py", "content": "#\n# Heatmapper\n# Geocoordinate\n#\n# This file contains the ShinyLive application for Geocoordinate Heatmapper.\n# It can be run with the following command within this directory:\n#\t\tshinylive export . [site]\n# Where [site] is the destination of the site folder.\n#\n# If you would rather deploy the application as a PyShiny application,\n# run the following command within this directory:\n#\t\tshiny run\n#\n#\n\n\nfrom shiny import App, Inputs, Outputs, Session, reactive, render, ui\nfrom shiny.types import FileInfo\nfrom folium import Map as FoliumMap\nfrom folium.plugins import HeatMap\nfrom pandas import DataFrame, read_csv, read_excel, read_table\nfrom pathlib import Path\nfrom io import BytesIO\nfrom sys import modules\nfrom copy import deepcopy\n\n\n# Interoperability between ShinyLive and PyShiny\nif \"pyodide\" in modules:\n\tfrom pyodide.http import pyfetch\n\tSource = \"https://raw.githubusercontent.com/kkernick/kkernick.github.io/main/geocoordinate/example_input/\"\n\tasync def download(url): r = await pyfetch(url); return await r.bytes() if r.ok else None\nelse:\n\tfrom os.path import exists\n\tSource = \"../example_input/\"\n\tasync def download(url): return open(url, \"rb\").read() if exists(url) else None\n\n\ndef server(input: Inputs, output: Outputs, session: Session):\n\n\tCache = {}\n\tBase = {}\n\n\tInfo = {\n\t\t\"example1.txt\": \"This example dataset shows deaths from a cholera outbreak in 1854. John Snow used this data in conjunction with local pump locations as evidence that cholera is spread by contaminated water. A digitised version of the data is available online, courtesy of Robin Wilson (robin@rtwilson.com).\",\n\t\t\"example2.txt\": \"This example data set shows bike thefts in Vancouver in 2011. The data was obtained from a 2013 Vancouver Sun blog post by Chad Skelton.\",\n\t\t\"example3.txt\": \"This example data set shows the location of traffic signals in Toronto. The data was obtained from Toronto Open Data. The idea to use this data set comes from this R-bloggers post by Myles Harrison.\"\n\t}\n\n\n\tdef HandleData(n, i):\n\t\t\"\"\"\n\t\t@brief Given the file name n, handle the file at i\n\t\t@param n The name of the file, extension is used to differentiate\n\t\t@param i The path to the file.\n\t\t\"\"\"\n\t\tmatch Path(n).suffix:\n\t\t\tcase \".csv\": df = read_csv(i)\n\t\t\tcase \".xlsx\": df = read_excel(i)\n\t\t\tcase _: df = read_table(i)\n\t\treturn df.fillna(0)\n\n\tasync def RawData():\n\t\t\"\"\"\n\t\t@brief Returns a DataFrame containing the heatmap table\n\t\t@returns \tA DataFrame, who's format can either be a matrix grid, or a chart\n\t\t\t\t\t\t\tcontaining x, y, and value columns.\n\t\t\"\"\"\n\n\t\t# Grab an uploaded file, if its done, or grab an example (Using a cache to prevent redownload)\n\t\tif input.SourceFile() == \"Upload\":\n\t\t\tfile: list[FileInfo] | None = input.File()\n\t\t\tif file is None:\n\t\t\t\t\treturn DataFrame()\n\t\t\tn = file[0][\"name\"]\n\n\t\t\tif n not in Base: Base[n] = HandleData(n, file[0][\"datapath\"])\n\t\telse:\n\t\t\tn = input.Example()\n\t\t\tif n not in Base: Base[n] = HandleData(n, BytesIO(await download(Source + n)))\n\n\t\tif n not in Cache: Cache[n] = deepcopy(Base[n])\n\t\treturn n\n\n\n\tasync def LoadData(): n = await RawData(); return DataFrame() if n is None else Cache[n]\n\n\n\tasync def LoadMap():\n\t\t\"\"\"\n\t\t@brief Generates a map with the provided information\n\t\t@returns the Folium.Map\n\t\t\"\"\"\n\n\t\tdf = await LoadData()\n\n\t\t# Give a placeholder map if nothing is selected, which should never really be the case.\n\t\tif df.empty: return FoliumMap((53.5213, -113.5213), tiles=input.MapType(), zoom_start=15)\n\n\t\t# Get the long and lat.\n\t\tlongitudes = df[\"Longitude\"].tolist()\n\t\tlatitudes = df[\"Latitude\"].tolist()\n\n\t\t# Guess the associated value for plotting.\n\t\tvalues = []\n\t\tfor option in [\"Value\", \"Year\"]:\n\t\t\tif option in df:\n\t\t\t\tvalues = df[option].tolist()\n\t\t\t\tbreak\n\t\tif not values: values = [1] * len(longitudes)\n\n\n\t\t#  Get the data ready.\n\t\tdata = list(zip(latitudes, longitudes, values))\n\n\t\t# Find a decent initial zoom.\n\t\tmap = FoliumMap((latitudes[0], longitudes[0]), tiles=input.MapType())\n\t\tHeatMap(data, min_opacity=input.Opacity(), radius=input.Radius(), blur=input.Blur()).add_to(map)\n\t\tmap.fit_bounds(map.get_bounds())\n\n\t\treturn map\n\n\n\t@output\n\t@render.data_frame\n\t@reactive.event(input.Update, input.Reset, input.Example, input.File, ignore_none=False, ignore_init=False)\n\tasync def LoadedTable(): return await LoadData()\n\n\n\t@output\n\t@render.ui\n\t@reactive.event(input.Update, input.Reset, input.Example, input.File, ignore_none=False, ignore_init=False)\n\tasync def Map(): return await LoadMap()\n\n\n\t@output\n\t@render.text\n\tdef ExampleInfo(): return Info[input.Example()]\n\n\n\t@render.download(filename=\"table.csv\")\n\tasync def DownloadTable(): df = await LoadData(); yield df.to_string()\n\n\n\t@render.download(filename=\"heatmap.html\")\n\tasync def DownloadHeatmap(): m = await LoadMap(); yield m.get_root().render()\n\n\n\t@reactive.Effect\n\t@reactive.event(input.Update)\n\tasync def Update():\n\t\t\"\"\"\n\t\t@brief Updates the value in the table with the one the user typed in upon updating\n\t\t\"\"\"\n\n\t\t# Get the data\n\t\tdf = await LoadData()\n\n\t\trow_count, column_count = df.shape\n\t\trow, column = input.TableRow(), input.TableCol()\n\n\t\t# So long as row and column are sane, update.\n\t\tif row < row_count and column < column_count:\n\t\t\tmatch input.Type():\n\t\t\t\tcase \"Integer\": df.iloc[row, column] = int(input.TableVal())\n\t\t\t\tcase \"Float\": df.iloc[row, column] = float(input.TableVal())\n\t\t\t\tcase \"String\": df.iloc[row, column] = input.TableVal()\n\n\n\t@reactive.Effect\n\t@reactive.event(input.Reset)\n\tasync def Reset(): del Cache[await RawData()]\n\n\n\t@reactive.Effect\n\t@reactive.event(input.TableRow, input.TableCol, input.Example, input.File, input.Reset, input.Update)\n\tasync def UpdateTableValue():\n\t\t\"\"\"\n\t\t@brief Updates the label for the Value input to display the current value.\n\t\t\"\"\"\n\t\tdf = await LoadData()\n\n\t\trows, columns = df.shape\n\t\trow, column = int(input.TableRow()), int(input.TableCol())\n\n\t\tif 0 <= row <= rows and 0 <= column <= columns:\n\t\t\tui.update_text(id=\"TableVal\", label=\"Value (\" + str(df.iloc[row, column]) + \")\", value=0),\n\n\napp_ui = ui.page_fluid(\n\n\tui.panel_title(title=None, window_title=\"Heatmapper\"),\n\tui.navset_bar(\n\t\tui.nav_panel(ui.HTML('<a href=https://kkernick.github.io/expression/site/index.html target=\"_blank\" rel=\"noopener noreferrer\">Expression</a>'), value=\"Expression\"),\n\t\tui.nav_panel(ui.HTML('<a href=https://kkernick.github.io/pairwise/site/index.html target=\"_blank\" rel=\"noopener noreferrer\">Pairwise</a>'), value=\"Pairwise\"),\n\t\tui.nav_panel(ui.HTML('<a href=https://kkernick.github.io/image/site/index.html target=\"_blank\" rel=\"noopener noreferrer\">Image</a>'), value=\"Image\"),\n\t\tui.nav_panel(ui.HTML('<a href=https://kkernick.github.io/geomap/site/index.html target=\"_blank\" rel=\"noopener noreferrer\">Geomap</a>'), value=\"Geomap\"),\n\t\tui.nav_panel(ui.HTML('<a href=https://kkernick.github.io/geocoordinate/site/index.html target=\"_blank\" rel=\"noopener noreferrer\">Geocoordinate</a>'), value=\"Geocoordinate\"),\n\t\tui.nav_panel(ui.HTML('<a href=https://kkernick.github.io/about/site/index.html target=\"_blank\" rel=\"noopener noreferrer\">About</a>'), value=\"About\"),\n\t\ttitle=\"Heatmapper\",\n\t\tselected=\"Geocoordinate\",\n\t),\n\n\tui.layout_sidebar(\n\t\tui.sidebar(\n\n\t\t\t# If the user needs help with the formatting.\n\t\t\tui.HTML('<a href=https://kkernick.github.io/about/site/index.html target=\"_blank\" rel=\"noopener noreferrer\">Data Format</a>'),\n\n\t\t\t# Specify whether to use example files, or upload one.\n\t\t\tui.input_radio_buttons(id=\"SourceFile\", label=\"Specify a Source File\", choices=[\"Example\", \"Upload\"], selected=\"Example\"),\n\n\t\t\t# Only display an input dialog if the user is one Upload\n\t\t\tui.panel_conditional(\n\t\t\t\t\"input.SourceFile === 'Upload'\",\n\t\t\t\tui.input_file(\"File\", \"Choose a File\", accept=[\".csv\", \".txt\", \"xlsx\"], multiple=False),\n\t\t\t),\n\n\t\t\t# Otherwise, add the example selection and an info button.\n\t\t\tui.panel_conditional(\n\t\t\t\t\"input.SourceFile === 'Example'\",\n\n\t\t\t\t# Put them side-by-side.\n\t\t\t\tui.layout_columns(\n\n\t\t\t\t\tui.input_select(id=\"Example\", label=None, choices={\n\t\t\t\t\t\t\"example1.txt\": \"Example 1\",\n\t\t\t\t\t\t\"example2.txt\": \"Example 2\",\n\t\t\t\t\t\t\"example3.txt\": \"Example 3\"},\n\t\t\t\t\t\tmultiple=False),\n\t\t\t\t\tui.popover(ui.input_action_link(id=\"ExampleInfoButton\", label=\"Info\"), ui.output_text(\"ExampleInfo\")),\n\t\t\t\t\tcol_widths=[10,2],\n\t\t\t\t)\n\t\t\t),\n\n\t\t\tui.layout_columns(\n\t\t\t\tui.input_action_button(\"Update\", \"Update\"),\n\t\t\t\tui.popover(ui.input_action_link(id=\"UpdateInfo\", label=\"?\"),\n\t\t\t\t\t\"Heatmapper will automatically update the heatmap when you change the file source. However, when modifying the table or changing feature visibility, you'll need to update the view manually.\"\n\t\t\t\t),\n\t\t\t\tcol_widths=[11,1],\n\t\t\t),\n\n\t\t\tui.layout_columns(\n\t\t\t\tui.input_action_button(\"Reset\", \"Reset Values\"),\n\t\t\t\tui.popover(ui.input_action_link(id=\"ResetInfo\", label=\"?\"),\n\t\t\t\t\t\"If you modify the values displayed in the Table Tab, you can reset the values back to their original state with this button.\"\n\t\t\t\t),\n\t\t\t\tcol_widths=[11,1],\n\t\t\t),\n\n\t\t\tui.br(),\n\n\t\t\t# All the features related to map customization are here.\n\t\t\tui.HTML(\"Map Customization\"),\n\n\t\t\t# Only OpenStreatMap and CartoDB Positron seem to work.\n\t\t\tui.input_radio_buttons(id=\"MapType\", label=\"Map Type\", choices=[\"OpenStreetMap\", \"CartoDB Positron\"], selected=\"CartoDB Positron\"),\n\n\t\t\tui.input_slider(id=\"Opacity\", label=\"Heatmap Opacity\", value=0.5, min=0.0, max=1.0, step=0.1),\n\t\t\tui.input_slider(id=\"Radius\", label=\"Size of Points\", value=25, min=5, max=50, step=5),\n\t\t\tui.input_slider(id=\"Blur\", label=\"Blurring\", value=15, min=1, max=30, step=1),\n\n\t\t\t# Add the download buttons.\n\t\t\t\"Download\",\n\t\t\tui.download_button(\"DownloadHeatmap\", \"Heatmap\"),\n\t\t\tui.download_button(\"DownloadTable\", \"Table\"),\n\n\t\t\tid=\"SidebarPanel\",\n\t\t),\n\n\t\t# Add the main interface tabs.\n\t\tui.navset_tab(\n\t\t\t\tui.nav_panel(\"Interactive\", ui.output_ui(\"Map\")),\n\t\t\t\tui.nav_panel(\"Table\",\n\t\t\t\t\tui.layout_columns(\n\t\t\t\t\t\tui.input_numeric(\"TableRow\", \"Row\", 0),\n\t\t\t\t\t\tui.input_numeric(\"TableCol\", \"Column\", 0),\n\t\t\t\t\t\tui.input_text(\"TableVal\", \"Value\", 0),\n\t\t\t\t\t\tui.input_select(id=\"Type\", label=\"Datatype\", choices=[\"Integer\", \"Float\", \"String\"]),\n\t\t\t\t\t\tcol_widths=[2,2,6,2],\n\t\t\t\t\t),\n\t\t\t\t\tui.output_data_frame(\"LoadedTable\"),\n\t\t\t\t),\n\t\t),\n\t)\n)\n\napp = App(app_ui, server)", "type": "text"}, {"name": "requirements.txt", "content": "folium\nbranca\ncertifi\nxyzservices", "type": "text"}]